{"version":3,"file":"Fetcher.js","sourceRoot":"","sources":["../../../../src/lib/utils/Fetcher.ts"],"names":[],"mappings":"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","sourcesContent":["import { URL } from 'url';\nimport fetch, { Request, RequestInit } from 'node-fetch';\nimport Cache, { CacheDataType } from './Cache.js';\n\nexport enum FetchMethod {\n  GET = 'GET',\n  POST = 'POST',\n  HEAD = 'HEAD'\n}\n\nexport interface FetcherParams {\n  cookie?: string | null;\n  cache: Cache;\n}\n\nexport default class Fetcher {\n\n  #cookie?: string | null;\n  #cache: Cache;\n\n  constructor(params: FetcherParams) {\n    this.#cache = params.cache;\n    this.setCookie(params.cookie);\n  }\n\n  setCookie(value?: string | null) {\n    this.#cookie = value;\n    const valueChanged = ((this.#cookie || null) !== (value || null));\n    if (valueChanged) {\n      this.#cache.clear();\n    }\n  }\n\n  get cookie() {\n    return this.#cookie;\n  }\n\n  fetch(url: string, jsonResponse: false, method: FetchMethod.HEAD, payload?: undefined): Promise<{ ok: boolean, status: number }>;\n  fetch(url: string, jsonResponse: true, method?: FetchMethod, payload?: Record<string, any>): Promise<any>;\n  fetch(url: string, jsonResponse?: boolean, method?: FetchMethod, payload?: Record<string, any>): Promise<string>;\n  fetch(url: string, jsonResponse?: boolean, method?: FetchMethod, payload?: Record<string, any>) {\n    if (jsonResponse === undefined) {\n      jsonResponse = false;\n    }\n    return this.#cache.getOrSet(CacheDataType.Page, getCacheKey(url, jsonResponse, payload), async () => {\n      if (method === undefined) {\n        method = FetchMethod.GET;\n      }\n\n      if (method === FetchMethod.HEAD) {\n        const response = await fetch(url, { method: 'HEAD' });\n        return {\n          ok: response.ok,\n          status: response.status\n        };\n      }\n\n      let response;\n      if (method === FetchMethod.GET) {\n        const urlObj = new URL(url);\n        if (payload) {\n          for (const [ key, value ] of Object.entries(payload)) {\n            urlObj.searchParams.set(key, value);\n          }\n        }\n        try {\n          const request = new Request(urlObj.toString());\n          if (this.#cookie) {\n            request.headers.set('Cookie', this.#cookie);\n          }\n          response = await fetch(request);\n        }\n        catch (error) {\n          throw new FetchError(error);\n        }\n      }\n      else {\n        const init: RequestInit = {\n          method: 'POST',\n          body: payload ? JSON.stringify(payload) : undefined\n        };\n        const request = new Request(url);\n        request.headers.set('Content-Type', 'application/x-www-form-urlencoded');\n        if (this.#cookie) {\n          request.headers.set('Cookie', this.#cookie);\n        }\n        try {\n          response = await fetch(request, init);\n        }\n        catch (error) {\n          throw new FetchError(error);\n        }\n      }\n      if (response.status === 429) {\n        throw new FetchError({\n          message: '429 Too Many Requests',\n          code: 429\n        });\n      }\n      if (jsonResponse) {\n        return response.json();\n      }\n      return response.text();\n    });\n  }\n\n}\n\nfunction getCacheKey(url: string, jsonResponse: boolean, payload?: Record<string, any>): string {\n  return url + (jsonResponse ? ':json' : ':html') +\n    (payload ? `:${JSON.stringify(payload)}` : '');\n}\n\nexport class FetchError extends Error {\n  code?: number;\n\n  constructor(payload: any) {\n    super();\n    if (payload?.message) {\n      this.message = payload.message;\n    }\n    if (payload?.code) {\n      this.code = payload.code;\n    }\n    if (payload?.stack) {\n      this.stack = payload.stack;\n    }\n  }\n}\n"]}